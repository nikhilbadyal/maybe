<%# locals: (account_group:, mobile: false, all_tab: false, open: nil, **args) %>

<div id="<%= account_group.dom_id(tab: all_tab ? :all : nil, mobile: mobile) %>">
  <% is_open = open.nil? ? account_group.accounts.any? { |account| page_active?(account_path(account)) } : open %>
  <%= render DS::Disclosure.new(align: :left, open: is_open) do |disclosure| %>
    <% disclosure.with_summary_content do %>
      <div class="flex items-center gap-3">
        <%= icon "chevron-right", class: "group-open:transform group-open:rotate-90" %>
        <%= tag.span class: class_names("text-sm text-primary font-medium", "animate-pulse" => account_group.syncing?) do %>
          <%= account_group.name %>
        <% end %>
      </div>

      <div class="ml-auto text-right grow">
        <%= tag.p format_money(account_group.total_money), class: "text-sm font-medium text-primary" %>
        <%= turbo_frame_tag "#{account_group.key}_sparkline", src: accountable_sparkline_path(account_group.key), loading: "lazy", data: { controller: "turbo-frame-timeout", turbo_frame_timeout_timeout_value: 10000 } do %>
          <div class="flex items-center w-8 h-4 ml-auto">
            <div class="w-6 h-px bg-loader"></div>
          </div>
        <% end %>
      </div>
    <% end %>

    <% groups = account_group.grouped_accounts %>

    <% groups.each do |subtype, subtype_accounts| %>
      <% if subtype.present? %>
        <div class="px-3 pt-2 text-xs font-medium text-secondary">
          <%= Depository.short_subtype_label_for(subtype) %>
        </div>
      <% end %>
      <div class="space-y-1">
        <% subtype_accounts.each do |account| %>
          <%= render "accounts/account_row", account: account, account_group: account_group, mobile: mobile %>
        <% end %>
      </div>
    <% end %>

    <div class="my-2">
      <%= render DS::Link.new(
      href: new_polymorphic_path(account_group.key, step: "method_select"),
      text: "New #{account_group.name.downcase.singularize}",
      icon: "plus",
      full_width: true,
      variant: "ghost",
      frame: :modal,
      class: "justify-start"
    ) %>
    </div>
  <% end %>
</div>
